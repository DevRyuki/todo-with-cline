# アクティブコンテキスト

## 現在の作業焦点
- テスト環境の最適化
- フロントエンド実装
- Projects/Workspaces API実装
- ページレイアウト改善

## 最近の変更
- DBスキーマ定義（Drizzle）
- Todos CRUD API実装
- プロジェクト/ワークスペーススキーマ定義
- フィーチャーベース構造導入
- 認証バックエンド実装（NextAuth）
- パスワードリセット機能実装（Resend）
- 認証UI実装（ログイン/登録/リセット）
- コンポーネント適切分離
- モック型定義改善（jest.d.ts）
- TodoListコンポーネント実装
- コンポーネント/API統合テスト実装
- テスト用型定義ファイル作成
- E2Eテスト環境構築（Playwright）
- E2Eテスト実装
  - 認証関連テスト（サインイン/サインアップ/パスワードリセット）
  - Todoアプリ基本機能テスト（表示/完了状態切替）
  - テストデータベースリセット機能
- データフェッチング機能実装
  - Todoフェッチャー実装（APIとの通信）
  - Todoカスタムフック実装（useTodos）
  - エラーハンドリングとローディング状態管理
  - TodoListコンポーネントをカスタムフック使用に更新
- APIルートのインポートパス修正
- Jest設定の最適化
  - jest.config.tsの改善（next/jest使用）
  - jest.setup.tsへの移行
  - モジュールパスエイリアス設定
- テストファイルの構文エラー修正
  - 関数宣言の括弧の欠落修正
  - カンマの欠落修正
  - `async` キーワードの欠落修正
- setupTests.jsとsetupTests.cjsの重複解消
- テスト環境の問題解決
  - JSX変換エラー解消（`SyntaxError: Unexpected token '<'`）
  - TextEncoder未定義エラー解消（`ReferenceError: TextEncoder is not defined`）
  - Next.js環境エラーの一部解消（Request, Response, Headersクラスのモック）
  - Playwrightテストの分離（testPathIgnorePatternsで除外）
  - TodoListコンポーネントのエラーメッセージ修正
  - 認証関連テストのインポートエラー解消
  - ハンドラーテストの構文エラー修正（NextResponse.jsonのモック）
  - NextRequest/NextResponseのモック実装の改善（jest.setup.tsの更新）
  - auth.handler.tsファイルのコンソールエラーメッセージのカンマ欠落修正
  - todos.handler.tsファイルのコンソールエラーメッセージのカンマ欠落修正
  - use-todos.tsファイルのコンソールエラーメッセージのカンマ欠落修正
- TDD実践方法の詳細化
  - systemPatterns.mdにTDDの具体的な実践方法を追加
  - テスト→実装→リファクタリングの各ステップの詳細化
  - 実装例の追加
- モックライブラリの導入（jest-mock-extended）
  - 型安全なモックを簡単に作成
  - AuthServiceのモック問題を解決
- テストヘルパー関数の作成（src/test/helpers.ts）
  - createMockAuthService()
  - createMockRequest()
  - expectJsonResponse()
- NextResponseのモック簡素化（jest.setup.tsの修正）

## 進行中の作業
- テスト環境の改善（優先度：高）
  - ✅ モックライブラリの導入と活用
    - ❌ next-test-api-route-handlerの導入（APIルートテスト）- App Routerとの互換性の問題により不要と判断
    - ✅ MSWの導入（APIリクエストのモック）- フェッチャーのテストに有効
  - 🔄 Jest設定の最適化
    - ✅ テスト実行スクリプトの分離（コンポーネント/サービス/ハンドラー）
  - ✅ E2Eテスト拡充
    - ✅ Todoリスト機能のE2Eテスト修正（エラー表示時のdata-testid属性追加）
- TDD実践方法の改善（優先度：高）
  - 🔄 テスト粒度の最適化
- Todo作成・編集フォーム開発（優先度：中）
  - 🔄 基本フォームコンポーネント実装
  - 🔄 フォームバリデーション
  - 🔄 フォームモーダル実装
  - 🔄 メインページ統合
- Projects/Workspaces API実装（優先度：中）
  - 🔄 スキーマ定義の確認
  - 🔄 APIエンドポイント実装
  - 🔄 サービス層実装
  - 🔄 テスト実装
- ページレイアウト改善（優先度：中）
  - 🔄 基本レイアウト構造実装
  - 🔄 ナビゲーション実装
  - 🔄 レスポンシブデザイン対応
  - 🔄 テーマ・スタイリング調整
- UIコンポーネント設計（優先度：中）
  - 🔄 共通UIコンポーネント実装
  - 🔄 機能別コンポーネント実装
  - 🔄 フォームベースコンポーネント実装

## 次のステップ
1. **テスト環境の最適化**
   - 🔄 テスト実行スクリプトの分離（package.jsonの更新）
   - 🔄 @jest/globalsモジュールからjestをインポートする問題の解決
2. **フロントエンド実装**
   - ✅ ページタイトルの修正（完了）
   - ✅ Todoリスト表示コンポーネントの実装（完了）
   - ✅ 認証UI（サインイン/サインアップ/パスワードリセット）の実装（完了）
   - 🔄 Todo作成・編集フォーム実装
3. **Projects/Workspaces API実装**
   - 🔄 スキーマ定義の確認
   - 🔄 APIエンドポイント実装
   - 🔄 サービス層実装
   - 🔄 テスト実装
4. **ページレイアウト改善**
   - 🔄 基本レイアウト構造実装
   - 🔄 ナビゲーション実装
   - 🔄 レスポンシブデザイン対応

## アクティブな決定事項
- **TDD**: テスト→実装→リファクタリングサイクル
  - 赤（失敗するテスト作成）→緑（最小限のコード実装）→リファクタリング（品質向上）
  - テスト粒度は機能単位で、実装の詳細ではなく動作をテスト
  - モックは外部依存のみに使用し、テスト対象のコードは実際に実行
- **フィーチャーベース構造**: 機能ごとのコード整理
- **Drizzle ORM**: 型安全SQLクエリビルダー
- **Next.js App Router**: ルーティング/API統合
- **コンポーネント分離**: UI/データ/ロジック分離
- **NextAuth**: 認証システム
- **Resend**: メール送信
- **テスト戦略**: 単体テスト、統合テスト、コンポーネントテスト、E2Eテストの組み合わせ
- **E2Eテスト**: Playwrightを使用したブラウザテスト
- **UIコンポーネント**: Shadcn/UIを使用したコンポーネントライブラリ
- **Jest設定の最適化**: 
  - プロジェクト分割（components, hooks, services, handlers）
  - ESモジュールサポート
  - Next.js環境のモック
  - JSX変換設定（ts-jestのuseESMとjsx: 'react-jsx'）
- **テストモック戦略**:
  - NextResponse.jsonのモックには@ts-expect-errorディレクティブを使用
  - AuthServiceのモックにはjest.spyOnの使用を検討
  - モックの簡素化と標準化（jest-mock-extendedの導入）
- **NextRequest/NextResponseのモック実装**:
  - 拡張されたモッククラスの実装（URL、メソッド、ヘッダー、クッキーなどのプロパティを含む）
  - 便利なファクトリーメソッドの提供（withBody、withUrlAndMethod）
  - モジュールのモック化（jest.mock('next/server', ...)）
- **データベース設定**:
  - docker-compose.ymlのデータベース名は「postgres」を使用
  - .env.local.exampleのDB_NAMEも「postgres」を使用
  - 環境変数が設定されていない場合のデフォルト値も「postgres」を使用

## 現在の課題
- TDD実践の問題
  - テストの冗長性と可読性の低下
  - テスト間の依存関係
  - テスト粒度の不適切さ（実装の詳細に依存しすぎている）
- テスト環境の問題
  - Playwrightテストの実行方法（`npm run test:e2e`で実行する必要あり）
  - @jest/globalsモジュールからjestをインポートする問題（ESモジュール形式との互換性）
- フロントエンド実装の不足
  - ✅ ページタイトルの修正（解決済み：layout.tsxのメタデータは「Todo App」に設定）
  - ✅ Todoリスト表示コンポーネントのdata-testid属性（解決済み：data-testid="todo-list"属性を確認）
  - ✅ 認証UI（解決済み：各コンポーネントにdata-testid属性を追加）
    - ✅ SignInFormコンポーネント: data-testid="signin-form"
    - ✅ SignUpFormコンポーネント: data-testid="signup-form"
    - ✅ ForgotPasswordFormコンポーネント: data-testid="forgot-password-form"
    - ✅ ResetPasswordFormコンポーネント: data-testid="reset-password-form"
    - ✅ AuthInputコンポーネント: data-testid="${name}-input"
    - ✅ AuthButtonコンポーネント: ボタンの種類に応じたdata-testid
  - Todo作成・編集フォームが未実装
  - ページレイアウトが未実装
- データベース関連の問題
  - ✅ `todos`テーブルが作成されない問題（解決済み：drizzle-kitのpushコマンドを使用）
  - ✅ PostgreSQLのデータベース名（`public`）とスキーマ名（`public`）の混乱（解決済み）
  - ✅ `.env.local`の`DB_NAME`設定と`docker-compose.yml`の`POSTGRES_DB`設定の不一致（解決済み）
- DBリレーションシップ最適設計
- パフォーマンス最適化
- スケーラビリティ確保
- 認証セキュリティ強化
  - パスワード強度ポリシー
  - ユーザー列挙攻撃対策
- コンポーネントとAPIの連携テスト拡充
- E2Eテスト環境の安定性向上
  - テストデータの一貫性確保
  - テスト間の独立性維持
  - テスト実行速度の最適化
  - すべてのE2Eテストが失敗（UIコンポーネントが実装されていないため）

## 重要なメモ
- TDD実践のベストプラクティス:
  - テスト→実装→リファクタリングのサイクルを徹底する
  - 小さな単位でテストを書き、実装し、リファクタリングする
  - テストは実装の詳細ではなく、動作をテストする
  - モックは外部依存のみに使用し、テスト対象のコードは実際に実行する
  - テストの可読性を高めるために、AAA（Arrange-Act-Assert）パターンを使用する
- APIパターン: `/api/[resource]`
- フィーチャーモジュールは独立開発可能に
- UIはレスポンシブ設計
- 認証API:
  - `/api/auth/[...nextauth]`
  - `/api/auth/register`
  - `/api/auth/forgot-password`
  - `/api/auth/reset-password`
- モック型定義は`jest.d.ts`で管理
- パスワードは独立テーブルで管理
- テスト環境の改善:
  - JSX変換設定: ts-jestでuseESM: trueとjsx: 'react-jsx'を設定
  - Next.js環境のモック: MockRequest/MockResponse/MockHeadersクラスを実装
  - TextEncoder/TextDecoderのポリフィル: utilからインポート
  - Playwrightテスト: testPathIgnorePatternsで除外
  - NextResponse.jsonのモック: @ts-expect-errorディレクティブを使用
- E2Eテスト:
  - Playwrightフレームワーク使用
  - `npm run test:e2e`でテスト実行
  - `npm run test:e2e:ui`でUI表示モード
  - `npm run test:e2e:debug`でデバッグモード
  - テスト前にデータベースリセット（`tests/helpers/setup-db.ts`）
  - グローバルセットアップ（`tests/global-setup.ts`）
  - テストデータ自動生成
  - データテスト属性（`data-testid`）を使用したセレクタ
- Jest設定:
  - jest.config.tsでnext/jestを使用
  - jest.setup.tsでNext.js環境のモックとTextEncoderのポリフィルを設定
  - extensionsToTreatAsEsmで.tsと.tsxファイルをESモジュールとして扱う
